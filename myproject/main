#!/usr/bin/env -S mycmd myproject run
# -*- mode: shell-script; sh-shell: bash; sh-basic-offset: 4; sh-indentation: 4; coding: utf-8 -*-
# shellcheck shell=bash

set -o nounset -o errexit -o errtrace -o pipefail

myproject.register_task_definition_file_description "Tools to display my personal aspirational statements"

# --------------------------------------------------------------------------------------------------
# Project-Wide Variables

mycmd.trace "The following variables set by MyProject are used in the main task definition file:"
# shellcheck disable=SC2154
mycmd.trace "- MYPROJECT_ROOT_DIRECTORY:            ${MYPROJECT_ROOT_DIRECTORY}"
# shellcheck disable=SC2154
mycmd.trace "- MYPROJECT_TASK_DEFINITION_DIRECTORY: ${MYPROJECT_TASK_DEFINITION_DIRECTORY}"

readonly BUILD_DIR="${MYPROJECT_ROOT_DIRECTORY}/build"
readonly DATA_DIR="${MYPROJECT_ROOT_DIRECTORY}/data"
readonly EXECUTABLE="${BUILD_DIR}/aspirations"
readonly JPM_TREE_DIR="${MYPROJECT_ROOT_DIRECTORY}/jpm_tree"
readonly JPM_TREE_JANET_PATH="${JPM_TREE_DIR}/bin/janet"
readonly JANET_FORMAT_EXE="${JPM_TREE_DIR}/bin/janet-format"

mycmd.trace "Set the following variables:"
mycmd.trace "- BUILD_DIR:           ${BUILD_DIR}"
mycmd.trace "- DATA_DIR:            ${DATA_DIR}"
mycmd.trace "- EXECUTABLE:          ${EXECUTABLE}"
mycmd.trace "- JANET_FORMAT_EXE:    ${JANET_FORMAT_EXE}"
mycmd.trace "- JPM_TREE_DIR:        ${JPM_TREE_DIR}"
mycmd.trace "- JPM_TREE_JANET_PATH: ${JPM_TREE_JANET_PATH}"

# --------------------------------------------------------------------------------------------------
# Project File Sets

# All Files
myproject.register_fileset ALL_FILES
myproject.add_files_to_fileset ALL_FILES \
    "${MYPROJECT_ROOT_DIRECTORY}"/*.janet \
    "${MYPROJECT_TASK_DEFINITION_DIRECTORY}"/* \
    "${DATA_DIR}"/* \
    LICENSE \
    README.md

# Task Definition Files
myproject.register_fileset TASK_DEFINITION_FILES
myproject.add_files_to_fileset TASK_DEFINITION_FILES "${MYPROJECT_TASK_DEFINITION_DIRECTORY}"/*

# Janet Files
myproject.register_fileset JANET_FILES
myproject.find_and_add_files_to_fileset JANET_FILES \
    "${MYPROJECT_ROOT_DIRECTORY}" \
    -maxdepth 1 -type f -name "*.janet"

# --------------------------------------------------------------------------------------------------
# Main Tasks
function lint_all() {
    myproject.execute_tasks task-definition-files lint
}
myproject.register_task lint-all lint_all
myproject.register_task_description lint-all "Lint all project files."

function format_all() {
    myproject.execute_tasks task-definition-files format \; janet format
}

myproject.register_task format-all format_all
myproject.register_task_description format-all "Format all project files."

function all() {
    myproject.execute_tasks format-all \; lint-all \; janet build
}

myproject.register_task all
myproject.register_task_description all "Execute all build tasks: format, lint, and build."

mycmd.trace "Finished loading the main task definition file."
